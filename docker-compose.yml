services:
  moltbot-gateway:
    # Immagine buildata localmente con build-local.sh
    image: moltbot:local
    pull_policy: never  # IMPORTANTE: Non fare pull, usa immagine locale

    container_name: moltbot-gateway
    restart: unless-stopped

    # Sicurezza: esegui come utente non-privilegiato
    user: "1000:1000"

    environment:
      # Application Environment
      - NODE_ENV=production
      - HOME=/home/node
      - TERM=xterm-256color
      - BROWSER=echo

      # Network Binding
      - CLAWDBOT_GATEWAY_BIND=lan
      - CLAWDBOT_GATEWAY_PORT=18789

      # File Paths
      - CLAWDBOT_CONFIG_DIR=/home/node/.moltbot
      - CLAWDBOT_WORKSPACE_DIR=/home/node/clawd

      # Gateway Authentication (obbligatorio)
      - MOLTBOT_GATEWAY_TOKEN=${MOLTBOT_GATEWAY_TOKEN}
      - CLAWDBOT_GATEWAY_TOKEN=${MOLTBOT_GATEWAY_TOKEN}

      # AI Providers
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

      # Telegram Bot
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}

    volumes:
      # Bind mounts - usa path relativa per portabilit√†
      - ./data/config:/home/node/.moltbot
      - ./data/workspace:/home/node/clawd
      - /etc/localtime:/etc/localtime:ro

    ports:
      # Espone sulla porta 18789 (localhost only per sicurezza)
      - "127.0.0.1:18789:18789"

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:18789/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    init: true

    command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789"]